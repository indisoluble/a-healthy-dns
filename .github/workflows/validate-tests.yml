name: validate tests

on:
  workflow_run:
    workflows: ["test docker", "test python code", "test version"]
    types:
      - completed
    branches:
      - master

permissions:
  contents: read

jobs:
  validate-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: checkout code
      uses: actions/checkout@v4

    - name: validate all required workflows passed
      run: |
        COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
        echo "Validating workflows for commit: $COMMIT_SHA"
        
        WORKFLOWS=("Test Docker" "Test Python Code" "Test Version")
        
        for workflow in "${WORKFLOWS[@]}"; do
          echo "Checking workflow: $workflow"
          STATUS=$(gh run list --workflow="$workflow" --json conclusion,headSha --jq ".[] | select(.headSha==\"$COMMIT_SHA\") | .conclusion" | head -1)
          
          if [ -z "$STATUS" ]; then
            echo "‚è≥ Workflow '$workflow' hasn't run yet for this commit."
            exit 1
          elif [ "$STATUS" != "success" ]; then
            echo "‚ùå Workflow '$workflow' failed (status: $STATUS)"
            exit 1
          else
            echo "‚úÖ Workflow '$workflow' passed"
          fi
        done
        
        echo "üéâ All required workflows have passed successfully!"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
