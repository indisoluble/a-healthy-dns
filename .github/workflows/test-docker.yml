name: test docker

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: checkout code
      uses: actions/checkout@v4

    - name: set up docker buildx
      uses: docker/setup-buildx-action@v3

    - name: build docker image
      run: |
        docker build -t a-healthy-dns:test .

    - name: test docker image builds successfully
      run: |
        # Verify the image was created
        docker images a-healthy-dns:test

    - name: test docker image with alias zone configuration
      run: |
        # Create an isolated network for deterministic container-to-container checks
        docker network create --subnet 172.28.0.0/24 a-healthy-dns-test-net

        # Start backend service that health checks can reach
        docker run -d \
          --name a-healthy-dns-backend \
          --network a-healthy-dns-test-net \
          --ip 172.28.0.10 \
          nginx:alpine

        # Start DNS server with hosted zone plus alias zones
        docker run -d \
          --name a-healthy-dns-test \
          --network a-healthy-dns-test-net \
          -p 53053:53053/udp \
          -e DNS_HOSTED_ZONE="test.example.com" \
          -e DNS_ALIAS_ZONES='["test.other.com","test.another.com"]' \
          -e DNS_ZONE_RESOLUTIONS='{"www":{"ips":["172.28.0.10"],"health_port":80}}' \
          -e DNS_NAME_SERVERS='["ns1.test.example.com"]' \
          -e DNS_PORT="53053" \
          -e DNS_TEST_MIN_INTERVAL="1" \
          -e DNS_TEST_TIMEOUT="1" \
          -e DNS_LOG_LEVEL="debug" \
          a-healthy-dns:test

    - name: wait for dns server to start
      run: |
        # Wait a bit for the server to fully start
        sleep 5
        
        # Check if containers are still running
        docker ps | grep a-healthy-dns-backend
        docker ps | grep a-healthy-dns-test

    - name: test dns server functionality
      run: |
        set -euo pipefail

        # Install dig for testing
        sudo apt-get update && sudo apt-get install -y dnsutils

        wait_for_a_record() {
          local fqdn="$1"
          for attempt in $(seq 1 20); do
            answer="$(dig +short +time=1 +tries=1 @127.0.0.1 -p 53053 "${fqdn}" A)"
            if printf '%s\n' "${answer}" | grep -qx "172.28.0.10"; then
              echo "[OK] ${fqdn} resolved to 172.28.0.10"
              return 0
            fi
            sleep 1
          done

          echo "A record did not become healthy for ${fqdn}"
          dig +nocmd +noall +comments +answer @127.0.0.1 -p 53053 "${fqdn}" A || true
          return 1
        }

        # Hosted zone should resolve the healthy backend
        wait_for_a_record "www.test.example.com"

        # Alias zones must resolve to the same backend via the same relative record name
        wait_for_a_record "www.test.other.com"
        wait_for_a_record "www.test.another.com"

        # NS record should be present for hosted and alias zones
        for zone in test.example.com test.other.com test.another.com; do
          ns_answer="$(dig +short +time=1 +tries=1 @127.0.0.1 -p 53053 "${zone}" NS)"
          printf '%s\n' "${ns_answer}" | grep -qx "ns1.test.example.com." || {
            echo "Unexpected NS answer for ${zone}: ${ns_answer}"
            exit 1
          }
          echo "[OK] ${zone} NS record is correct"
        done

        # Valid alias zone but unknown subdomain should be NXDOMAIN
        dig +time=1 +tries=1 @127.0.0.1 -p 53053 missing.test.other.com A \
          | grep -q "status: NXDOMAIN"

        # Non-configured zones should remain NXDOMAIN
        dig +time=1 +tries=1 @127.0.0.1 -p 53053 www.not-configured.example.org A \
          | grep -q "status: NXDOMAIN"

    - name: test docker-compose configuration
      run: |
        # Test that docker-compose example file is valid
        if [ -f docker-compose.example.yml ]; then
          # Install docker-compose
          sudo apt-get install -y docker-compose
          
          # Validate the compose file syntax
          docker-compose -f docker-compose.example.yml config > /dev/null && echo "[OK] docker-compose.example.yml is valid"
        else
          echo "docker-compose.example.yml not found"
        fi

    - name: cleanup
      if: always()
      run: |
        # Stop and remove test containers
        docker stop a-healthy-dns-backend || true
        docker stop a-healthy-dns-test || true
        docker rm a-healthy-dns-backend || true
        docker rm a-healthy-dns-test || true

        # Remove test network
        docker network rm a-healthy-dns-test-net || true
        
        # Remove test image
        docker rmi a-healthy-dns:test || true
